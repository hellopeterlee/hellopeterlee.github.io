<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://hellopeterlee.github.io</id>
    <title>Wukong&apos;s Sky</title>
    <updated>2020-10-18T15:36:57.161Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://hellopeterlee.github.io"/>
    <link rel="self" href="https://hellopeterlee.github.io/atom.xml"/>
    <logo>https://hellopeterlee.github.io/images/avatar.png</logo>
    <icon>https://hellopeterlee.github.io/favicon.ico</icon>
    <rights>All rights reserved 2020, Wukong&apos;s Sky</rights>
    <entry>
        <title type="html"><![CDATA[Dcat自定义RowAction,模拟确认，并弹出工具表单]]></title>
        <id>https://hellopeterlee.github.io/post/dcat-zi-ding-yi-rowactionmo-ni-que-ren-bing-dan-chu-gong-ju-biao-dan/</id>
        <link href="https://hellopeterlee.github.io/post/dcat-zi-ding-yi-rowactionmo-ni-que-ren-bing-dan-chu-gong-ju-biao-dan/">
        </link>
        <updated>2020-10-18T15:19:36.000Z</updated>
        <content type="html"><![CDATA[<ul>
<li>我的需求是要求点击表格的一个按钮后，先进行一段业务逻辑后再弹出一个表单填写后续内容，</li>
<li>由于正常的Dcat的RowAction，点击后的confirm，是监控不到取消事件的，所以这里不能使用RowAction里面的confirm，需要调用Dcat.confirm自己实现，弹出后，再访问RowAction里面的handle方法，处理完成后，再调用layer的弹窗，显示出表单</li>
</ul>
<blockquote>
<p>注意下面代码中的通过ajax访问handle方法</p>
</blockquote>
<pre><code class="language-php">&lt;?php

namespace App\StaffAdmin\Actions\Grid;

use App\Admin\Renderable\ShowOrderDetails;
use App\Jobs\MchOrderNotifyJob;
use App\Models\MchOrder;
use Dcat\Admin\Admin;
use Dcat\Admin\Grid\RowAction;
use Dcat\Admin\Traits\HasPermissions;
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Http\Request;

class GetOrderAction extends RowAction
{
    protected $title = '抢单';

    public function render()
    {
        $this-&gt;appendHtmlAttribute('style', 'margin:2px');
        $this-&gt;addHtmlClass('btn btn-primary');
        return parent::render();
    }

    // 发起请求之前回调，返回false可以中断请求
    protected function actionScript()
    {
        $url = admin_url(&quot;dcat-api/action&quot;);

        // 通过ajax访问handle方法,参数规定如下:
        $data = json_encode(['_action' =&gt; str_replace('\\','_',__CLASS__), '_id' =&gt; $this-&gt;getKey()]);

        $id = $this-&gt;getKey();
        $detailsUrl = admin_url(&quot;orders/submit/{$id}&quot;);

        return &lt;&lt;&lt;JS
            function onActionScript(data, target, action) {
                (typeof closeAutoRefresh != 'undefined') &amp;&amp; closeAutoRefresh();

                Dcat.confirm('确定抢单吗？', null, function () {
                    $.post(&quot;$url&quot;,$data,function(res){
                        console.info('res',res)
                        if(res.status){
                            if(res.data.type=='success'){
                                Dcat.success(res.data.message);
                                layer.open({
                                    type : 2,
                                    content:'{$detailsUrl}',
                                    area: [&quot;800px&quot;,&quot;600px&quot;],
                                    end: function(){
                                      parent &amp;&amp; parent.location.reload();
                                    }
                                })
                            }else{
                                Dcat.error(res.data.message)
                                (typeof openAutoRefresh != 'undefined') &amp;&amp; openAutoRefresh();
                            }
                        }else{
                            Dcat.error('抢单失败')
                            (typeof openAutoRefresh != 'undefined') &amp;&amp; openAutoRefresh();
                        }
                    })
                },function(){ //这里就是confirm的取消按钮点击后...
                    (typeof openAutoRefresh != 'undefined') &amp;&amp; openAutoRefresh();
                });
                return false
            }
JS;
    }

    public function showOrderDetails()
    {
        $id = $this-&gt;getKey();
        $url = admin_url(&quot;orders/submit/{$id}&quot;);

        return $this-&gt;response()-&gt;script(&lt;&lt;&lt;JS
            layer.open({
                type : 2,
                content:'{$url}',
                area: [&quot;800px&quot;,&quot;600px&quot;],
                end: function(){
                  parent &amp;&amp; parent.location.reload();
                }
            })
JS
        );
    }

    public function handle(Request $request)
    {
        try {
            $id = $request-&gt;get('_id');

            $res = MchOrder::query()
                -&gt;where('id', $id)
                -&gt;where('pay_status', MchOrder::PayStatus_Ready)
                -&gt;update(['pay_status' =&gt; MchOrder::PayStatus_Paying, 'staff_id' =&gt; Admin::user()-&gt;id]);

            if ($res &gt; 0) {
                return $this-&gt;response()-&gt;success('抢单成功');
            } else {
                return $this-&gt;response()-&gt;error(&quot;抢单失败:已被他人抢走&quot; . $id);
            }
        } catch (\Exception $e) {
            return $this-&gt;response()-&gt;error($e-&gt;getMessage());
        }
    }


    /**
     * @param Model|Authenticatable|HasPermissions|null $user
     *
     * @return bool
     */
    protected function authorize($user): bool
    {
        return true;
    }

    /**
     * @return array
     */
    protected function parameters()
    {
        return [];
    }
}

</code></pre>
<p>如果不需要监控confirm的取消事件，就简单多了</p>
<blockquote>
<p>response()-&gt;script就可以在handle处理完后执行js代码：</p>
</blockquote>
<pre><code class="language-php">&lt;?php

namespace App\StaffAdmin\Actions\Grid;

use App\Admin\Renderable\ShowOrderDetails;
use App\Jobs\MchOrderNotifyJob;
use App\Models\MchOrder;
use Dcat\Admin\Admin;
use Dcat\Admin\Grid\RowAction;
use Dcat\Admin\Traits\HasPermissions;
use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Http\Request;

class GetOrderAction extends RowAction
{
    protected $title = '抢单';

    public function render()
    {
        $this-&gt;appendHtmlAttribute('style', 'margin:2px');
        $this-&gt;addHtmlClass('btn btn-primary');
        return parent::render();
    }

    public function showOrderDetails()
    {
        $id = $this-&gt;getKey();
        $url = admin_url(&quot;orders/submit/{$id}&quot;);

        return $this-&gt;response()-&gt;script(&lt;&lt;&lt;JS
            layer.open({
                type : 2,
                content:'{$url}',
                area: [&quot;50%&quot;,&quot;600px&quot;],
                end: function(){
                  parent &amp;&amp; parent.location.reload();
                }
            })
JS
        );
    }

    public function handle(Request $request)
    {
        try {
            $id = $this-&gt;getKey();

            $res = MchOrder::query()
                -&gt;where('id', $id)
                -&gt;where('pay_status', MchOrder::PayStatus_Ready)
                -&gt;update(['pay_status' =&gt; MchOrder::PayStatus_Paying, 'staff_id' =&gt; Admin::user()-&gt;id]);

            if ($res &gt; 0) {
                return $this-&gt;showOrderDetails();
            } else {
                return $this-&gt;response()-&gt;error(&quot;抢单失败:已被他人抢走&quot;);
            }
        } catch (\Exception $e) {
            return $this-&gt;response()-&gt;error($e-&gt;getMessage());
        }
    }

    /**
     * @return string|array|void
     */
    public function confirm()
    {
        return '确定抢单吗?';
    }

</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[一键搭建ssr + mtproxy_go + IPsec VPN server]]></title>
        <id>https://hellopeterlee.github.io/post/yi-jian-da-jian-ssr-mtproxy_go-ipsec-vpn-server/</id>
        <link href="https://hellopeterlee.github.io/post/yi-jian-da-jian-ssr-mtproxy_go-ipsec-vpn-server/">
        </link>
        <updated>2020-10-17T12:54:42.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ssr搭建">SSR搭建:</h2>
<pre><code>wget --no-check-certificate https://raw.githubusercontent.com/teddysun/shadowsocks_install/master/shadowsocksR.sh

chmod +x shadowsocksR.sh

./shadowsocksR.sh 2&gt;&amp;1 | tee shadowsocksR.log

/etc/init.d/shadowsocks start
</code></pre>
<p>开启加速：</p>
<pre><code>git clone -b master https://github.com/flyzy2005/ss-fly
ss-fly/ss-fly.sh -bbr
reboot

sysctl net.ipv4.tcp_available_congestion_control

显示成功：
net.ipv4.tcp_available_congestion_control = bbr cubic reno
</code></pre>
<h2 id="mtproxy_go搭建">MTProxy_go搭建</h2>
<pre><code>wget -N --no-check-certificate https://raw.githubusercontent.com/iiiiiii1/doubi/master/mtproxy_go.sh &amp;&amp; bash mtproxy_go.sh

/etc/init.d/mtproxy-go start
</code></pre>
<h2 id="ipsec-vpn-server搭建">IPsec VPN server搭建</h2>
<pre><code>wget https://git.io/vpnsetup-centos -O vpnsetup.sh &amp;&amp; sudo sh vpnsetup.sh
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[玩客云搭建cups打印服务器]]></title>
        <id>https://hellopeterlee.github.io/post/wan-ke-yun-da-jian-cups-da-yin-fu-wu-qi/</id>
        <link href="https://hellopeterlee.github.io/post/wan-ke-yun-da-jian-cups-da-yin-fu-wu-qi/">
        </link>
        <updated>2020-10-17T12:46:25.000Z</updated>
        <content type="html"><![CDATA[<h3 id="相关命令">相关命令</h3>
<pre><code>apt-get update
apt-get upgrade
apt-get -y install cups avahi-daemon hplip
systemctl restart cups
</code></pre>
<p>接下来安装hp的相关插件<br>
打开网址 [https://www.openprinting.org/download/printdriver/auxfiles/HP/plugins/]<br>
下载这两个文件：<br>
hplip-3.16.11-plugin.run，hplip-3.16.11-plugin.run.asc</p>
<pre><code>wget https://www.openprinting.org/download/printdriver/auxfiles/HP/plugins/hplip-3.16.11-plugin.run
wget https://www.openprinting.org/download/printdriver/auxfiles/HP/plugins/hplip-3.16.11-plugin.run.asc
</code></pre>
<p><code>sudo hp-plugin -i -g</code><br>
选择P选项，手动指定hplip-3.16.11-plugin.run位置<br>
选择y选项，确定安装这个插件</p>
<p>删除系统自动认出添加上的打印机，然后手动添加（系统会认出相应打印机，选中添加即可）</p>
]]></content>
    </entry>
</feed>